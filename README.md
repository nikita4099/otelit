# ML System Design Doc - Остап Бендер v0.1 [RU]
## Дизайн ML системы - Отелит Подбор Арендатора №1

*Шаблон ML System Design Doc от телеграм-канала [Reliable ML](https://t.me/reliable_ml)*   

- Рекомендации по процессу заполнения документа (workflow) - [здесь](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru/blob/main/ML_System_Design_Doc_Workflow.md). 
- [Шаблон дизайн-дока](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru)
- Детальный доклад о том, что такое ML System Design Doc и о том, как, когда и зачем его составлять - **будет туть**.
    
> ## Термины и пояснения
> - Товар - помещение, которое сдаётся в аренду
> - Клиент - компания или предприниматель, который ищет или искал помещение в аренду и уже обращался в компанию в его поисках, но не обязательно заключил сделку
> - Сделка - подписанный и оплаченный договор аренды
> - Лид - Клиент, который еще не был проверен Менеджером и не получил первичную подборку коммерческих предложений
> - ИММО - Итерация по моделированию машинного обучения (ИММО). Состоит из шагов поиска данных, их обработки, подготовки к машинному обучению, само машинное обучение и анализ полученных результатов

### 1. Цели и предпосылки 
#### 1.1. Зачем идем в разработку продукта?  

- Бизнес-цель: увеличить среднюю конверсию из лида в сделку для арендаторов до 4-5% с текущих 2-3%
- Почему станет лучше, чем сейчас, от использования:  система сможет прогнозировать сделку лучше, чем это делает человек, так как может анализировать сотни свободных помещений под конкретный запрос клиента, вместо топ 5-7 самых востребованных у менеджера в моменте.  

#### 1.2. Бизнес-требования и ограничения  

- [Бизнес-требования](https://github.com/nikita4099/otelit/blob/main/Бизнес-требования)
- [Бизнес ограничения](https://github.com/nikita4099/otelit/blob/main/Бизнес%20ограничения)
- Что мы ожидаем от конкретной итерации: проверка достаточности данных, построение модели на локальной машине на имеющихся данных. Уточнение признаков, метрик и их целевых значение. 
- Логика работы ML:  Машинное обучение работает по принципу запрос-ответ. Из CRM системы поступает запрос с данными о клиенте (признаками для предикта). В ответ система выдаёт ответ с номерами айди товаров которые на её взгляд приведут к сделке у данного менеджера с данным клиентом
- Критерии успеха и возможные пути развития проекта: успешной будет модель, которая предлагает убирает заведомо не подходящие варианты на уровне опытного менеджера. Численно точность оценить получится на стадии тестирования. Шаг 1 (Остап v1.0). Убрать всё не подходящее. Модель классификации товаров. Товары классифицируются на подходящий и неподходящий. Версии модели отличаются уровнем качества. Подверсии удобством и устойчивостью.  Шаг 2 (Остап v2.0). Ранжировать подходящее. Рекомендательная система. Товары расставляются в порядке вероятности заключения сделки. Версии модели отличаются по уровню качества. Подверсии - интерпретируемостью модели, устойчивостью. Шаг 3(Остап v3.0). Рекомендательная система подбора арендатора. Товарам рекомендуются клиенты. Модель оценивает сумму и вероятность сделки. Версии отличаются точностью. Подверсии - удобством и устойчивостью.

#### 1.3. Что входит в скоуп проекта/итерации, что не входит   

- На закрытие каких БТ подписываемся в данной итерации: проверка работоспособности модели на имеющихся данных в юпитере на локальной машине без выкатывания в прод или развертывания бэка на сервере. Собираем данные, обрабатываем, обучаем модели, смотрим результат.
- Что не будет закрыто: в этой итерации не будет закрыто требование успеха проекта - повышение конверсии, поскольку мы это пока не измеряем. Пока не выкатываем в рабочий кластер. Не определяем нужный стэк и ресурсы. Не занимаемся настройкой фронта на строне б24.
- Результат с точки зрения качества кода и воспроизводимости решения: в данный момент рабочая тетрадь юпитера, в котором подняты первичные данные и сделана МЛ, способная делать предикты для новых клиентов. Внутри комментарии касаемо сделанных шагов, как нужно обработать данные в базе и того, что нужно сделать для безотказной работы.
- Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации): настройка пайплайна, версирование моделей и данных. Описать ограничения и требования. Определить стэк.

#### 1.4. Предпосылки решения  

- Описание всех общих предпосылок решения, используемых в системе: Используем признаки описанные ниже. Горизонтом прогноза выступает сделка. Гранулярность: клиент-товар-сделка.

### 2. Методология    

#### 2.1. Постановка задачи  

- Что делаем с технической точки зрения: в V1.0 MVP - это задача классификации. В V2.0 и V3.0 - рекомендательные системы.

#### 2.2. Блок-схема решения  

- Блок-схема для MVP и пилота с ключевыми этапами решения задачи: [тут](https://github.com/nikita4099/otelit/blob/8110929d721e79ae79a238e29ae8034a794282bf/%D0%91%D0%BB%D0%BE%D0%BA%20%D1%81%D1%85%D0%B5%D0%BC%D0%B0%20%D0%9E%D1%81%D1%82%D0%B0%D0%BF.PNG)

#### 2.3. Этапы решения задачи. Заполняется по мере прохождения шагов.  

- Этап 1 - подготовка MVP. 

Шаг 1 - Определение цели и бизнес-процесса пилота. Задача определиться с целью проекта, примерной метрикой и прокси-метриками, по которым будем делать первичную проверку MVP. Также нужно определить эти значения для отправного бейзлайна, по которому MVP будет считаться пригодной для переходу к запуску модели в пилот. После подтверждения заказчиком важности метрики и её цели, а также согласия дата-саентистом и дата-инженеров на пробу в достижении поставленной цели переходим к шагу 2.

Выбранные цели: 
- CR из лида в сделку 4,5%. 
Выбранные метрики: 
- прокси-метрики: Например, сколько из созданных сделок было размечено нашей моделью фоном в качестве некачественных.
- метрики качества модели: высокий recall. Например, 0.8.
- Гранулярность: Товар-Клиент-Сделка
#### 3.2. Что считаем успешным пилотом
  
Формализованные в пилоте метрики оценки успешности `Product Owner`: recall = 0.8 **Ира: это на каких данных? На тестовых? Только recall? А при обучении модели на какие метрики смотрим?**  Для пилота проверяем результаты на примере лидов последней неделе. Запускаем и проверяем, сколько товаров очевидных система убрала не верно. Если в 8 из 10 лидов не будет потерь подходящих помещений, то модель считаем успешной.

- Какие метрики качества используем и почему они связаны с бизнес-результатом, обозначенным `Product Owner` в разделах `1` и `3`. Пример - WAPE <= 50% для > 80% категорий, bias ~ 0. Возможна формулировка в терминах относительно бейзлайна, количественно. Для бейзлайна могут быть свои целевые метрики, а может их вообще не быть (если это обосновано) `Data Scientist`: не понятно **Ира: у вас задача классификации. Для нее существуют различные метрики качества. В какие метрики качества целимся? На какие из них смотрим наиболее пристально. В том числе, с учетом ожидаемого дисбаланса классов. Заполняется ML-специалистом, как правило.** recall =0.8. У нас имеется больше 100 предложений. Для каждого клиента они не подходят. Для самого универсального клиента список предложений может доходить до 10-15 помещений. Поэтому больше 70 строк - это шум, который нам надо убрать. После его убирания менеджеру сложней упустить что-то хорошее и подходящее клиенту, по этой причине он будет предлагать больше помещений, а значит с большей вероятностью заключит сделку с конкретным клиентом. Таким образом конверсия должна вырасти.

Шаг 2 - Фиксация бизнес требований и Определение ограничений. Фиксируем те ограничения, которые нам кажутся существенными и которые несут риск для нашей модели. После фиксации известных требований и ограничений переходим к шагу 3.

[Бизнес-требования](https://github.com/nikita4099/otelit/blob/main/Бизнес-требования)
[Бизнес ограничения](https://github.com/nikita4099/otelit/blob/main/Бизнес%20ограничения)

Шаг 3 - Прохождение ИММО на локальной машине. Собираем данные согласно плану, готовим их попутно фиксируя выявленные проблемы в данных. После обработки проводим поиск хороших моделей и наблюдаем за выбранными метриками качества. ИММО повторяется до тех пор, пока MVP не достигнет уровня бейзлана - качества модели, при котором МЛ на тестовых данных проходит проверку на адекватность. При повторении ИММО в данные добавляются признаки и подбираются модели. При достижении уровня бейзлайна переходим к шагу 4.

[Признаки](https://github.com/nikita4099/otelit/blob/main/Признаки%20для%20Остапа)
[Предобработка](https://github.com/nikita4099/otelit/blob/b245f15ca08c75f43d935573a25664294a0e2c0d/data_preparation)
[Поиск лучшей модели](https://github.com/nikita4099/otelit/blob/1b2e81ec5a2fa84a118e927836578b581695d493/best_model_search)

Шаг 4. - Развертывание ИММО согласно бизнес требованиям заказчика. Готовим стэк согласно требованиям заказчика, переносим туда наш бейзлайн и добиваемся того, чтобы модель могла исполняться согласно заявленной логике. После этого переходим к шагу 5.

- Этап 2 - подготовка пилота.

Шаг 5. - Утверждение метрик. Определяем финальные метрики, прокси-метрики и технические метрики, при достижении которых модель будет запущена в деплой. Цели подтверждает заказчик, дата-саентист и дата-инженер, после этого переходим к шагу 6.

- Необходимый уровень

Шаг 6. - Подготовка модели к деплою. Проводим обогощение модели данными, улучшаем предобработку и подбор параметров модели до тех пор, пока не удастся достичь заявленные цели.

Признаки:
- Обучающие
- Целевой
Предобработка:
- Критерии для признаков
- Способ обработки

Шаг 7. - Работа с ограничениями для запуска пилота. Проверяем выполнение всех требований закачика, устраняем ограничения и проверяем систему на устойчивость. Выявленные критичные риски фиксируем и передаём заказчику в качестве системных требований. После этого переходим к шагу 8.

Ограничения:
Требования:

Шаг 8. - Деплой. Выкатываем модель в рабочую среду и проводим тестирование на достижение метрик и отказоустойчивости согласно требованиям.

- Краткое описание результата этапа - что должно быть на выходе: витрины данных, потоки данных, др. : не понятно **Ира: в вашем случае, если я правильно понимаю - витрины данных для модели** Допустим =) Тоже бы ликбез провести, чем витрины данных от потоков отличаются и какие есть еще варианты.

#### 2.4 Какие могут быть риски и что планируем с этим делать. 

Например, необходимый для модели фактор (флаг промо) окажется незначимым для большинства моделей. Или для 50% моделей будет недостаточно данных для оценки `Data Scientist`: данные хреново заполнены - будем привлекать практикатов для разметки данных. Результат неоднозначный: то, что должно точно остаться - убыло, то, что должно было точно убыть - осталось. **Ира: здесь снова возвращаемся к вопросу о том, что нужно детальнее прописать/определить для себя алгоритм - как будем понимать достаточность данных** С этим есть сложность. Эта информация в границах "не знаю то, что не знаю". Скорей всего конкретные значения будут в процессе реализации. То есть нужно получить начальный результат и после этого скажу, какой он должен быть. Есть еще риск, что из-за того, что обучение будет делаться для лидов на ретроспективных данных, а на товарах текущего дня - это может запутать систему. Тут либо убирать данные о том, каким бизнесом занимается арендатор на сегодня в товаре, либо поднимать как-то данные ретроспективные по товарам и запускать модель учиться со старого периода к текущему дню.  


> ### Материалы для дополнительного погружения в тему  
> - [Шаблон ML System Design Doc [EN] от AWS](https://github.com/eugeneyan/ml-design-docs) и [статья](https://eugeneyan.com/writing/ml-design-docs/) с объяснением каждого раздела  
> - [Верхнеуровневый шаблон ML System Design Doc от Google](https://towardsdatascience.com/the-undeniable-importance-of-design-docs-to-data-scientists-421132561f3c) и [описание общих принципов его заполнения](https://towardsdatascience.com/understanding-design-docs-principles-for-achieving-data-scientists-53e6d5ad6f7e).
> - [ML Design Template](https://www.mle-interviews.com/ml-design-template) от ML Engineering Interviews  
> - Статья [Design Documents for ML Models](https://medium.com/people-ai-engineering/design-documents-for-ml-models-bbcd30402ff7) на Medium. Верхнеуровневые рекомендации по содержанию дизайн-документа и объяснение, зачем он вообще нужен  
> - [Краткий Canvas для ML-проекта от Made with ML](https://madewithml.com/courses/mlops/design/#timeline). Подходит для верхнеуровневого описания идеи, чтобы понять, имеет ли смысл идти дальше.  
